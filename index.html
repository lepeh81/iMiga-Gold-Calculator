<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iMiga Gold Calculator by Lepeh</title>
    
    <style>
        /* CSS STYLING */
        :root {
            --bg-color: #1a1a1a;
            --card-bg: #2c2c2c;
            --gold-accent: #d4af37;
            --gold-hover: #b5952f;
            --text-white: #ffffff;
            --text-gray: #cccccc;
            --input-bg: #3d3d3d;
            --input-border: #555;
            --error-color: #ff6b6b;
            --positive-green: #4caf50;
            --tab-inactive: #3d3d3d;
            --highlight-bg: #2e3b2f;
            --highlight-border: #4caf50;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-white);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .calculator-card {
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            width: 100%;
            max-width: 900px; /* Wider for table */
            border-top: 5px solid var(--gold-accent);
        }

        h1 {
            text-align: center;
            color: var(--gold-accent);
            margin-bottom: 0.5rem;
            margin-top: 0;
        }

        p.subtitle {
            text-align: center;
            color: var(--text-gray);
            font-size: 0.9rem;
            margin-bottom: 2rem;
        }

        /* --- MAIN TABS --- */
        .main-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
            gap: 1rem;
            border-bottom: 1px solid #444;
            padding-bottom: 1rem;
            flex-wrap: wrap; /* Allow wrapping on small screens */
        }

        .main-tab-btn {
            background-color: transparent;
            color: var(--text-gray);
            border: 2px solid #444;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            flex: 1;
            min-width: 120px;
            max-width: 200px;
        }

        .main-tab-btn:hover {
            border-color: var(--gold-accent);
            color: var(--text-white);
        }

        .main-tab-btn.active {
            background-color: var(--gold-accent);
            color: #1a1a1a;
            border-color: var(--gold-accent);
        }

        /* Tab Content Container */
        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }

        /* Chart Container */
        .chart-container {
            margin-bottom: 1rem;
            border: 1px solid #444;
            border-radius: 10px;
            overflow: hidden;
            height: 350px; /* Fixed height for chart */
        }

        /* Ticker Container */
        .ticker-container {
            margin-bottom: 1rem;
            border-radius: 10px;
            overflow: hidden;
            width: 100%;
            border: 1px solid #444;
            background-color: #1e222d;
        }

        /* Prediction/Trend Container */
        .prediction-section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #444;
        }

        .insight-box {
            background-color: #252525;
            border-left: 4px solid var(--gold-accent);
            padding: 1rem;
            border-radius: 0 8px 8px 0;
            font-size: 0.9rem;
            color: var(--text-gray);
        }

        .insight-box h3 {
            margin: 0 0 0.5rem 0;
            color: var(--text-white);
            font-size: 1.1rem;
        }

        .insight-box strong {
            color: var(--gold-accent);
        }

        .disclaimer {
            font-size: 0.8rem;
            margin-top: 0.8rem;
            font-style: italic;
            opacity: 0.7;
        }

        /* Top Section for Market Price Input */
        .market-price-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 2rem;
            background-color: #252525;
            padding: 1.5rem;
            border-radius: 10px;
            border: 1px solid #444;
        }

        .input-group {
            width: 100%;
            max-width: 300px;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: var(--gold-accent);
            font-weight: 600;
            text-align: center;
        }

        input {
            width: 100%;
            padding: 12px;
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.2s;
            text-align: center;
        }

        input:focus {
            outline: none;
            border-color: var(--gold-accent);
        }

        /* Table Styling */
        .table-container {
            overflow-x: auto; /* Scroll on mobile */
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 10px; /* Space between rows */
            min-width: 600px; /* Ensure table doesn't squish too much */
        }

        th {
            color: var(--text-gray);
            font-size: 0.85rem;
            text-transform: uppercase;
            padding: 10px;
            letter-spacing: 1px;
            border-bottom: 1px solid #444;
        }

        td {
            padding: 0 10px;
            vertical-align: middle;
        }

        .data-row {
            background-color: #333;
            transition: transform 0.2s;
            border-radius: 8px;
        }
        
        .data-row:hover {
            background-color: #383838;
        }

        .data-row.best-deal {
            background-color: #2e3b2f; /* Greenish tint for best deal */
            border: 1px solid #4caf50;
        }

        .data-row td:first-child { border-top-left-radius: 8px; border-bottom-left-radius: 8px; }
        .data-row td:last-child { border-top-right-radius: 8px; border-bottom-right-radius: 8px; }

        .table-input {
            background-color: #222;
            border: 1px solid #444;
            padding: 10px;
            font-size: 0.95rem;
        }

        .result-cell {
            text-align: center;
            font-weight: bold;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.1rem;
        }

        .spread-cell {
            color: var(--gold-accent);
        }

        /* Suggestion Box */
        .suggestion-box {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: var(--highlight-bg);
            border: 2px solid var(--highlight-border);
            border-radius: 10px;
            text-align: center;
            display: none; /* Hidden by default */
            animation: fadeIn 0.5s ease;
        }

        .suggestion-text {
            color: #ffffff;
            font-size: 1.1rem;
            font-weight: bold;
            display: block;
            margin-bottom: 0.5rem;
        }
        
        .suggestion-icon {
            font-size: 1.5rem;
            margin-right: 10px;
        }

        .save-btn {
            background-color: #4caf50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
            margin-top: 10px;
            transition: background 0.2s;
        }

        .save-btn:hover {
            background-color: #45a049;
        }

        /* History Table Specifics */
        .history-table {
            width: 100%;
            border-collapse: collapse;
        }

        .history-table th {
            text-align: left;
            padding: 12px;
            background-color: #333;
            color: var(--gold-accent);
        }

        .history-table td {
            padding: 12px;
            border-bottom: 1px solid #444;
            color: #ddd;
        }

        .history-date {
            color: #888;
            font-size: 0.85rem;
        }

        /* Error Message */
        .error-msg {
            color: var(--error-color);
            font-size: 0.85rem;
            text-align: center;
            margin-top: 1rem;
            display: none;
        }

        /* Remove arrows from number inputs */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
    </style>
</head>
<body>

    <div class="calculator-card">
        <h1>iMiga Gold Calculator by Lepeh</h1>
        <p class="subtitle">Compare purchase options against the market price.</p>

        <!-- Main Tabs Navigation -->
        <div class="main-tabs">
            <button class="main-tab-btn active" onclick="switchMainTab('tab-calculator', this)">Gold Calculator</button>
            <button class="main-tab-btn" onclick="switchMainTab('tab-analysis', this)">Market Analysis</button>
            <button class="main-tab-btn" onclick="switchMainTab('tab-history', this)">Deal History</button>
        </div>

        <!-- TAB 1: MARKET ANALYSIS -->
        <div id="tab-analysis" class="tab-content">
            <!-- Chart Container -->
            <div class="chart-container">
                <!-- TradingView Widget BEGIN -->
                <div class="tradingview-widget-container">
                    <div id="tradingview_chart"></div>
                    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
                    <script type="text/javascript">
                    new TradingView.widget(
                    {
                    "autosize": true,
                    "symbol": "FX_IDC:XAUMYR/31.1035", 
                    "interval": "60",
                    "timezone": "Asia/Kuala_Lumpur",
                    "theme": "dark",
                    "style": "1",
                    "locale": "en",
                    "enable_publishing": false,
                    "hide_top_toolbar": false,
                    "hide_legend": false,
                    "save_image": false,
                    "container_id": "tradingview_chart",
                    "backgroundColor": "rgba(44, 44, 44, 1)"
                    }
                    );
                    </script>
                </div>
                <!-- TradingView Widget END -->
            </div>

            <!-- Live Price Ticker Container -->
            <div class="ticker-container">
                <div class="tradingview-widget-container">
                    <div class="tradingview-widget-container__widget"></div>
                    <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-single-quote.js" async>
                    {
                    "symbol": "FX_IDC:XAUMYR/31.1035",
                    "width": "100%",
                    "colorTheme": "dark",
                    "isTransparent": true,
                    "locale": "en"
                    }
                    </script>
                </div>
            </div>

            <!-- Technical Rating Meter (XAU/USD) -->
            <div class="prediction-section">
                <h2 style="text-align:center; color:white; font-size:1.2rem; margin-bottom:0.5rem;">Technical Rating (XAU/USD)</h2>
                
                <div class="tradingview-widget-container" style="height: 500px;">
                    <div class="tradingview-widget-container__widget"></div>
                    <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-technical-analysis.js" async>
                    {
                    "interval": "1m",
                    "width": "100%",
                    "isTransparent": true,
                    "height": "100%",
                    "symbol": "OANDA:XAUUSD",
                    "showIntervalTabs": true,
                    "displayMode": "single",
                    "locale": "en",
                    "colorTheme": "dark"
                    }
                    </script>
                </div>

                <div class="insight-box">
                    <h3>ðŸ”® Technical Insight</h3>
                    <p>This widget analyzes oscillators and moving averages for XAU/USD (OANDA).</p>
                    <ul style="padding-left: 20px; margin-top: 5px;">
                        <li>Use the <strong>tabs above</strong> (1m, 5m, 15m, 1h, etc.) to change the timeframe.</li>
                        <li><strong style="color: #4caf50;">Strong Buy</strong> suggests strong bullish momentum.</li>
                        <li><strong style="color: #ff6b6b;">Strong Sell</strong> suggests strong bearish momentum.</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- TAB 2: GOLD CALCULATOR (Default Active) -->
        <div id="tab-calculator" class="tab-content active">
            <!-- Global Market Price Input -->
            <div class="market-price-section">
                <div class="input-group">
                    <label for="marketPrice">Enter Market Price (RM / g)</label>
                    <input type="number" id="marketPrice" placeholder="e.g. 385.50" step="0.01" oninput="calculateAll()">
                </div>
            </div>

            <!-- Comparison Table -->
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th>Buy (RM)</th>
                            <th>Gold (Gram)</th>
                            <th>Gold/Gram (RM)</th>
                            <th>Spread/Gram (RM)</th>
                        </tr>
                    </thead>
                    <tbody id="comparisonBody">
                        <!-- Row 1 -->
                        <tr class="data-row" id="row-0">
                            <td style="text-align: center; color: #666;">1</td>
                            <td><input type="number" class="table-input buy-input" placeholder="0.00" oninput="calculateAll()"></td>
                            <td><input type="number" class="table-input weight-input" value="0.014" step="0.001" oninput="calculateAll()"></td>
                            <td class="result-cell cost-output">-</td>
                            <td class="result-cell spread-output">-</td>
                        </tr>
                        <!-- Row 2 -->
                        <tr class="data-row" id="row-1">
                            <td style="text-align: center; color: #666;">2</td>
                            <td><input type="number" class="table-input buy-input" placeholder="0.00" oninput="calculateAll()"></td>
                            <td><input type="number" class="table-input weight-input" value="0.015" step="0.001" oninput="calculateAll()"></td>
                            <td class="result-cell cost-output">-</td>
                            <td class="result-cell spread-output">-</td>
                        </tr>
                        <!-- Row 3 -->
                        <tr class="data-row" id="row-2">
                            <td style="text-align: center; color: #666;">3</td>
                            <td><input type="number" class="table-input buy-input" placeholder="0.00" oninput="calculateAll()"></td>
                            <td><input type="number" class="table-input weight-input" value="0.016" step="0.001" oninput="calculateAll()"></td>
                            <td class="result-cell cost-output">-</td>
                            <td class="result-cell spread-output">-</td>
                        </tr>
                        <!-- Row 4 -->
                        <tr class="data-row" id="row-3">
                            <td style="text-align: center; color: #666;">4</td>
                            <td><input type="number" class="table-input buy-input" placeholder="0.00" oninput="calculateAll()"></td>
                            <td><input type="number" class="table-input weight-input" value="0.017" step="0.001" oninput="calculateAll()"></td>
                            <td class="result-cell cost-output">-</td>
                            <td class="result-cell spread-output">-</td>
                        </tr>
                        <!-- Row 5 -->
                        <tr class="data-row" id="row-4">
                            <td style="text-align: center; color: #666;">5</td>
                            <td><input type="number" class="table-input buy-input" placeholder="0.00" oninput="calculateAll()"></td>
                            <td><input type="number" class="table-input weight-input" value="0.018" step="0.001" oninput="calculateAll()"></td>
                            <td class="result-cell cost-output">-</td>
                            <td class="result-cell spread-output">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Automatic Suggestion Box -->
            <div id="suggestionArea" class="suggestion-box">
                <span class="suggestion-icon">ðŸ’¡</span>
                <span id="suggestionText" class="suggestion-text"></span>
                <button class="save-btn" onclick="saveBestDeal()">Save Record</button>
            </div>
            
            <div id="errorArea" class="error-msg"></div>
        </div>

        <!-- TAB 3: DEAL HISTORY -->
        <div id="tab-history" class="tab-content">
            <h2 style="text-align:center; color: var(--gold-accent);">Best Suggestions (Last 3 Months)</h2>
            <div class="table-container">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Date / Time</th>
                            <th>Weight</th>
                            <th>Price/g</th>
                            <th>Total Buy (RM)</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                        <!-- History items will be injected here -->
                    </tbody>
                </table>
            </div>
            <div style="text-align:center; margin-top:1rem;">
                <button onclick="clearHistory()" style="background:transparent; color:#888; border:1px solid #555; padding:5px 10px; cursor:pointer; border-radius:5px;">Clear History</button>
            </div>
        </div>

    </div>

    <script>
        // State to hold the current best deal for saving
        let currentBestDeal = null;

        // Initialize History on Load
        window.onload = function() {
            loadHistory();
        };

        // Main Tab Switching Logic
        function switchMainTab(tabId, btnElement) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.main-tab-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            btnElement.classList.add('active');
        }

        // Calculator Logic
        function calculateAll() {
            const marketPriceInput = document.getElementById('marketPrice');
            const marketPrice = parseFloat(marketPriceInput.value);
            const errorArea = document.getElementById('errorArea');
            const suggestionArea = document.getElementById('suggestionArea');
            const suggestionText = document.getElementById('suggestionText');

            errorArea.style.display = 'none';
            suggestionArea.style.display = 'none';
            currentBestDeal = null; // Reset best deal

            const rows = document.querySelectorAll('.data-row');
            
            let maxCostPerGram = -Infinity; 
            let bestDealObj = null;

            rows.forEach(row => {
                row.classList.remove('best-deal');

                const buyInput = row.querySelector('.buy-input');
                const weightInput = row.querySelector('.weight-input');
                const costOutput = row.querySelector('.cost-output');
                const spreadOutput = row.querySelector('.spread-output');

                const buyVal = parseFloat(buyInput.value);
                const weightVal = parseFloat(weightInput.value);

                const validMarket = !isNaN(marketPrice) && marketPrice > 0;
                const validRow = !isNaN(buyVal) && !isNaN(weightVal) && weightVal > 0;

                if (validRow) {
                    const costPerGram = buyVal / weightVal;
                    
                    costOutput.innerText = costPerGram.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    
                    if (validMarket) {
                        const spreadPerGram = costPerGram - marketPrice;
                        const sign = spreadPerGram > 0 ? "+" : "";
                        spreadOutput.innerText = sign + spreadPerGram.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                        spreadOutput.style.color = spreadPerGram >= 0 ? '#d4af37' : '#4caf50'; 
                    } else {
                        spreadOutput.innerText = "-";
                        spreadOutput.style.color = "inherit";
                    }

                    if (costPerGram > maxCostPerGram) { 
                        maxCostPerGram = costPerGram;
                        bestDealObj = {
                            weight: weightVal,
                            costPerGram: costPerGram,
                            buyAmount: buyVal,
                            rowId: row.id
                        };
                    }
                } else {
                    costOutput.innerText = "-";
                    spreadOutput.innerText = "-";
                    spreadOutput.style.color = "inherit";
                }
            });

            if (bestDealObj !== null) {
                suggestionText.innerText = `Belian ${bestDealObj.weight}g adalah lebih menguntungkan`;
                suggestionArea.style.display = 'block';
                if(bestDealObj.rowId) {
                    document.getElementById(bestDealObj.rowId).classList.add('best-deal');
                }
                currentBestDeal = bestDealObj;
            }
        }

        // HISTORY FUNCTIONS

        function saveBestDeal() {
            if (!currentBestDeal) return;

            const newRecord = {
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                weight: currentBestDeal.weight,
                costPerGram: currentBestDeal.costPerGram,
                buyAmount: currentBestDeal.buyAmount,
                timestamp: Date.now() // For sorting
            };

            let history = getHistory();
            history.unshift(newRecord); // Add to top
            // Keep only top 50 to prevent overflow
            if(history.length > 50) history.pop();
            
            localStorage.setItem('goldCalcHistory', JSON.stringify(history));
            
            // Refresh table and alert user
            renderHistoryTable(history);
            alert("Record saved to Deal History!");
        }

        function getHistory() {
            const stored = localStorage.getItem('goldCalcHistory');
            if (stored) return JSON.parse(stored);
            
            // Only return empty array (real user data only)
            return [];
        }

        function loadHistory() {
            const history = getHistory();
            renderHistoryTable(history);
        }

        function renderHistoryTable(data) {
            const tbody = document.getElementById('historyBody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="4" style="text-align:center; padding:2rem; color:#666;">No history saved yet.</td>`;
                tbody.appendChild(row);
                return;
            }
            
            data.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div style="font-weight:bold;">${item.date}</div>
                        <div class="history-date">${item.time}</div>
                    </td>
                    <td>${item.weight}g</td>
                    <td style="color:#d4af37; font-weight:bold;">RM ${item.costPerGram.toFixed(2)}</td>
                    <td>RM ${item.buyAmount.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function clearHistory() {
            if(confirm("Are you sure you want to clear history?")) {
                localStorage.removeItem('goldCalcHistory');
                loadHistory(); 
            }
        }
    </script>
</body>
</html>
