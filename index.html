<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-V3PF0MMH74"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-V3PF0MMH74');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iMiga Gold Calculator by Lepeh</title>
    
    <style>
        /* CSS STYLING */
        :root {
            --bg-color: #1a1a1a;
            --card-bg: #2c2c2c;
            --gold-accent: #d4af37;
            --gold-hover: #b5952f;
            --text-white: #ffffff;
            --text-gray: #cccccc;
            --input-bg: #3d3d3d;
            --input-border: #555;
            --error-color: #ff6b6b;
            --positive-green: #4caf50;
            --tab-inactive: #3d3d3d;
            --highlight-bg: #2e3b2f;
            --highlight-border: #4caf50;
            --ai-msg-bg: #3d3d3d;
            --user-msg-bg: #d4af37;
            --user-msg-text: #1a1a1a;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-white);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px; /* Reduced padding for mobile */
            box-sizing: border-box;
        }

        .calculator-card {
            background-color: var(--card-bg);
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            width: 100%;
            max-width: 900px; 
            border-top: 5px solid var(--gold-accent);
            position: relative;
        }

        /* Mode Switcher Styling */
        .mode-switcher {
            position: absolute;
            top: 10px; /* Moved slightly up */
            right: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0,0,0,0.4);
            padding: 6px 12px;
            border-radius: 20px;
            z-index: 20;
            backdrop-filter: blur(4px);
        }

        .mode-label {
            font-size: 0.7rem;
            color: var(--text-gray);
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        h1 {
            text-align: center;
            color: var(--gold-accent);
            margin-bottom: 0.5rem;
            margin-top: 5.5rem; /* Increased top margin for mobile header clearance */
            font-size: 1.5rem;
            line-height: 1.3;
        }

        p.subtitle {
            text-align: center;
            color: var(--text-gray);
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }

        /* --- MAIN TABS --- */
        .main-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
            gap: 0.5rem;
            border-bottom: 1px solid #444;
            padding-bottom: 1rem;
            flex-wrap: wrap; 
        }

        .main-tab-btn {
            background-color: transparent;
            color: var(--text-gray);
            border: 2px solid #444;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s;
            flex: 1;
            min-width: 100px;
            text-align: center;
        }

        .main-tab-btn:hover {
            border-color: var(--gold-accent);
            color: var(--text-white);
        }

        .main-tab-btn.active {
            background-color: var(--gold-accent);
            color: #1a1a1a;
            border-color: var(--gold-accent);
        }

        /* Tab Content Container */
        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }

        /* Chart Container */
        .chart-container {
            margin-bottom: 1rem;
            border: 1px solid #444;
            border-radius: 10px;
            overflow: hidden;
            height: 350px; 
        }

        /* Ticker Container */
        .ticker-container {
            margin-bottom: 1rem;
            border-radius: 10px;
            overflow: hidden;
            width: 100%;
            border: 1px solid #444;
            background-color: #1e222d;
        }

        /* Prediction/Trend Container */
        .prediction-section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #444;
        }

        .insight-box {
            background-color: #252525;
            border-left: 4px solid var(--gold-accent);
            padding: 1rem;
            border-radius: 0 8px 8px 0;
            font-size: 0.9rem;
            color: var(--text-gray);
        }

        .insight-box h3 {
            margin: 0 0 0.5rem 0;
            color: var(--text-white);
            font-size: 1.1rem;
        }

        .insight-box strong {
            color: var(--gold-accent);
        }

        .disclaimer {
            font-size: 0.8rem;
            margin-top: 0.8rem;
            font-style: italic;
            opacity: 0.7;
        }

        /* Expert Info Box */
        .expert-info {
            margin-top: 15px;
            padding: 10px;
            background-color: #222;
            border: 1px dashed #555;
            border-radius: 8px;
            font-size: 0.8rem;
            color: #aaa;
            display: none; /* Hidden by default */
        }
        
        .expert-info strong {
            color: var(--gold-accent);
        }
        
        .expert-info code {
            background-color: #111;
            padding: 2px 5px;
            border-radius: 3px;
            color: #ccc;
            font-family: monospace;
        }

        /* Top Section for Market Price Input */
        .market-price-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 1.5rem;
            background-color: #252525;
            padding: 1rem;
            border-radius: 10px;
            border: 1px solid #444;
        }

        .input-group {
            width: 100%;
            max-width: 300px;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: var(--gold-accent);
            font-weight: 600;
            text-align: center;
        }

        input {
            width: 100%;
            padding: 12px;
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.2s;
            text-align: center;
        }

        input:focus {
            outline: none;
            border-color: var(--gold-accent);
        }

        /* TOGGLE SWITCH STYLES */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555;
            -webkit-transition: .4s;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
        }

        input:checked + .slider {
            background-color: var(--gold-accent);
        }

        input:focus + .slider {
            box-shadow: 0 0 1px var(--gold-accent);
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(20px);
            -ms-transform: translateX(20px);
            transform: translateX(20px);
        }

        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        /* Table Styling - Responsive */
        .table-container {
            overflow-x: auto; 
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px; 
        }

        th {
            color: var(--text-gray);
            font-size: 0.8rem;
            text-transform: uppercase;
            padding: 8px 4px;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #444;
            text-align: center;
        }

        td {
            padding: 0 4px;
            vertical-align: middle;
        }

        .data-row {
            background-color: #333;
            transition: transform 0.2s;
            border-radius: 8px;
        }
        
        .data-row:hover {
            background-color: #383838;
        }

        .data-row.best-deal {
            background-color: #2e3b2f; 
            border: 1px solid #4caf50;
        }

        .data-row td:first-child { border-top-left-radius: 8px; border-bottom-left-radius: 8px; }
        .data-row td:last-child { border-top-right-radius: 8px; border-bottom-right-radius: 8px; }

        .table-input {
            background-color: #222;
            border: 1px solid #444;
            padding: 8px;
            font-size: 0.9rem;
            width: 100%;
            text-align: center;
        }

        /* Highlight optimal buy fields */
        .ai-buy-input {
            color: var(--gold-accent);
            font-weight: bold;
            border-color: #555;
        }

        .result-cell {
            text-align: center;
            font-weight: bold;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.95rem; /* Slightly smaller for mobile fit */
        }

        .premium-col {
            display: none; /* Default hidden */
        }

        .spread-cell {
            color: var(--gold-accent);
        }

        /* Suggestion Box */
        .suggestion-box {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: var(--highlight-bg);
            border: 2px solid var(--highlight-border);
            border-radius: 10px;
            text-align: center;
            display: none; 
            animation: fadeIn 0.5s ease;
        }

        .suggestion-text {
            color: #ffffff;
            font-size: 1rem;
            display: block;
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }
        
        .suggestion-icon {
            font-size: 1.5rem;
            margin-right: 10px;
        }

        .save-btn, .analyze-btn {
            background-color: #4caf50;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85rem;
            margin: 5px;
            transition: background 0.2s;
        }
        
        .analyze-btn {
            background-color: var(--gold-accent);
            color: #1a1a1a;
        }

        .save-btn:hover { background-color: #45a049; }
        .analyze-btn:hover { background-color: #b5952f; }

        /* History Table Specifics */
        .history-table {
            width: 100%;
            border-collapse: collapse;
        }

        .history-table th {
            text-align: left;
            padding: 10px;
            background-color: #333;
            color: var(--gold-accent);
            font-size: 0.85rem;
        }

        .history-table td {
            padding: 10px;
            border-bottom: 1px solid #444;
            color: #ddd;
            font-size: 0.9rem;
        }

        .history-date {
            color: #888;
            font-size: 0.8rem;
        }

        /* CHAT / AI SECTION STYLES */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 500px;
            border: 1px solid #444;
            border-radius: 10px;
            background-color: #222;
            overflow: hidden;
            position: relative;
        }

        .api-config-area {
            background-color: #2a2a2a;
            padding: 10px;
            border-bottom: 1px solid #444;
            display: none; 
        }

        .api-config-area.visible { display: block; }

        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .config-toggle-btn {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 1.2rem;
            position: absolute;
            top: 10px;
            right: 15px;
            z-index: 10;
        }
        
        .config-toggle-btn:hover { color: var(--gold-accent); }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding-top: 40px; 
        }

        .message {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .message.user {
            align-self: flex-end;
            background-color: var(--user-msg-bg);
            color: var(--user-msg-text);
            border-bottom-right-radius: 2px;
        }

        .message.ai {
            align-self: flex-start;
            background-color: var(--ai-msg-bg);
            color: var(--text-white);
            border-bottom-left-radius: 2px;
            border: 1px solid #444;
        }

        .chat-input-area {
            display: flex;
            flex-direction: column;
            padding: 10px;
            border-top: 1px solid #444;
            background-color: #2c2c2c;
            gap: 8px;
        }

        .chat-input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #555;
            background-color: #3d3d3d;
            color: white;
            font-size: 0.95rem;
            box-sizing: border-box;
        }

        .send-btn {
            background-color: var(--gold-accent);
            color: #1a1a1a;
            border: none;
            padding: 0 15px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }

        .send-btn:hover { background-color: #b5952f; }
        .send-btn:disabled { background-color: #555; cursor: not-allowed; }

        .error-msg {
            color: var(--error-color);
            font-size: 0.85rem;
            text-align: center;
            margin-top: 1rem;
            display: none;
        }

        /* Disclaimer Animation */
        .educational-disclaimer {
            margin-top: 20px;
            text-align: center;
            font-size: 0.75rem;
            color: #ff4444;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            line-height: 1.4;
            animation: blink-red 2s infinite ease-in-out;
            border-top: 1px solid #444;
            padding-top: 15px;
        }

        @keyframes blink-red {
            0% { opacity: 1; color: #ff4444; }
            50% { opacity: 0.5; color: #cc0000; }
            100% { opacity: 1; color: #ff4444; }
        }

        /* MOBILE SPECIFIC OVERRIDES */
        @media (max-width: 600px) {
            .calculator-card {
                padding: 1rem;
            }
            
            h1 { 
                font-size: 1.2rem;
                margin-top: 5.5rem; /* SIGNIFICANT INCREASE for iPhone 14 Notch/Toggle Clearance */
            }
            
            .table-container {
                /* Allows horizontal scroll ONLY if absolutely necessary, but we try to fit */
                overflow-x: auto; 
            }

            table {
                min-width: 100%; 
                border-spacing: 0 4px;
            }

            th, td {
                padding: 6px 2px;
                font-size: 0.7rem; /* Smaller font for mobile */
            }
            
            /* Hide Row # on very small screens to save space */
            th:first-child, td:first-child {
                width: 20px;
                font-size: 0.7rem;
            }

            input.table-input {
                padding: 6px 2px;
                font-size: 0.75rem;
            }
            
            .result-cell {
                font-size: 0.75rem;
            }
            
            .main-tab-btn {
                padding: 6px 10px;
                font-size: 0.8rem;
                min-width: 80px;
            }
        }

        /* Remove arrows from number inputs */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
    </style>
</head>
<body>

    <div class="calculator-card">
        <!-- MODE SWITCHER -->
        <div class="mode-switcher">
            <span id="appModeLabel" class="mode-label" style="color:#fff;">Beginner</span>
            <label class="switch" style="width:34px; height:18px;">
                <input type="checkbox" id="appModeToggle" onchange="toggleAppMode()">
                <span class="slider round" style="background-color: #555;"></span>
            </label>
            <span class="mode-label">Expert</span>
        </div>

        <h1>iMiga Gold Calculator by Lepeh</h1>
        <p class="subtitle">Compare purchase options against the market price.</p>

        <!-- Main Tabs Navigation (Hidden in Beginner Mode) -->
        <div class="main-tabs" id="mainTabsNav" style="display:none;">
            <button class="main-tab-btn" onclick="switchMainTab('tab-calculator', this)">Gold Calculator</button>
            <button class="main-tab-btn active" onclick="switchMainTab('tab-ai-calculator', this)">Ai Gold Calculator</button>
            <button class="main-tab-btn" onclick="switchMainTab('tab-analysis', this)">Market Analysis</button>
            <button class="main-tab-btn" onclick="switchMainTab('tab-history', this)">Deal History</button>
            <button class="main-tab-btn" onclick="switchMainTab('tab-ai', this)">‚ú® AI Advisor</button>
        </div>

        <!-- TAB 1: GOLD CALCULATOR (Manual) -->
        <div id="tab-calculator" class="tab-content">
            <!-- Global Market Price Input -->
            <div class="market-price-section">
                <div class="input-group">
                    <label for="marketPrice">Enter Market Price (RM / g)</label>
                    <input type="number" id="marketPrice" placeholder="e.g. 385.50" step="0.01" oninput="calculateAll()">
                </div>
            </div>

            <!-- Comparison Table -->
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 30px;">#</th>
                            <th>Buy (RM)</th>
                            <th>Gold (g)</th>
                            <th>Cost/g (RM)</th>
                            <th class="premium-col">Premium/g (RM)</th>
                        </tr>
                    </thead>
                    <tbody id="comparisonBody">
                        <tr class="data-row" id="row-0">
                            <td style="text-align: center; color: #666;">1</td>
                            <td><input type="number" class="table-input buy-input" placeholder="0.00" oninput="calculateAll()"></td>
                            <td><input type="number" class="table-input weight-input" value="0.014" step="0.001" oninput="calculateAll()"></td>
                            <td class="result-cell cost-output">-</td>
                            <td class="result-cell spread-output premium-col">-</td>
                        </tr>
                        <tr class="data-row" id="row-1">
                            <td style="text-align: center; color: #666;">2</td>
                            <td><input type="number" class="table-input buy-input" placeholder="0.00" oninput="calculateAll()"></td>
                            <td><input type="number" class="table-input weight-input" value="0.015" step="0.001" oninput="calculateAll()"></td>
                            <td class="result-cell cost-output">-</td>
                            <td class="result-cell spread-output premium-col">-</td>
                        </tr>
                        <tr class="data-row" id="row-2">
                            <td style="text-align: center; color: #666;">3</td>
                            <td><input type="number" class="table-input buy-input" placeholder="0.00" oninput="calculateAll()"></td>
                            <td><input type="number" class="table-input weight-input" value="0.016" step="0.001" oninput="calculateAll()"></td>
                            <td class="result-cell cost-output">-</td>
                            <td class="result-cell spread-output premium-col">-</td>
                        </tr>
                        <tr class="data-row" id="row-3">
                            <td style="text-align: center; color: #666;">4</td>
                            <td><input type="number" class="table-input buy-input" placeholder="0.00" oninput="calculateAll()"></td>
                            <td><input type="number" class="table-input weight-input" value="0.017" step="0.001" oninput="calculateAll()"></td>
                            <td class="result-cell cost-output">-</td>
                            <td class="result-cell spread-output premium-col">-</td>
                        </tr>
                        <tr class="data-row" id="row-4">
                            <td style="text-align: center; color: #666;">5</td>
                            <td><input type="number" class="table-input buy-input" placeholder="0.00" oninput="calculateAll()"></td>
                            <td><input type="number" class="table-input weight-input" value="0.018" step="0.001" oninput="calculateAll()"></td>
                            <td class="result-cell cost-output">-</td>
                            <td class="result-cell spread-output premium-col">-</td>
                        </tr>
                        <!-- Row 6 (Manual Custom) -->
                        <tr class="data-row" id="row-5">
                            <td style="text-align: center; color: #666;">6</td>
                            <td><input type="number" class="table-input buy-input" placeholder="0.00" oninput="calculateAll()"></td>
                            <td><input type="number" class="table-input weight-input" placeholder="Manual" step="0.001" oninput="calculateAll()"></td>
                            <td class="result-cell cost-output">-</td>
                            <td class="result-cell spread-output premium-col">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Automatic Suggestion Box -->
            <div id="suggestionArea" class="suggestion-box">
                <span class="suggestion-icon">üí°</span>
                <span id="suggestionText" class="suggestion-text"></span>
                <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button class="save-btn" onclick="saveBestDeal()">Save Record</button>
                    <button class="analyze-btn" onclick="analyzeCurrentDeal()">‚ú® Analyze with AI</button>
                </div>
            </div>
            
            <div class="expert-info">
                <strong>Info Pakar:</strong><br>
                ‚Ä¢ Rumus Premium: <code>(Harga Belian √∑ Berat) - Harga Spot</code><br>
                ‚Ä¢ Sumber Harga Spot: <code>Input Pengguna</code>
            </div>

            <div id="errorArea" class="error-msg"></div>
        </div>

        <!-- TAB 2: AI GOLD CALCULATOR (Auto Live - Simplified in Beginner) -->
        <div id="tab-ai-calculator" class="tab-content active">
            <!-- Global Market Price Input (Auto) -->
            <div class="market-price-section">
                <div class="input-group" style="position: relative;">
                    <!-- Auto/Manual Switch -->
                    <div id="priceToggleContainer" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <label for="aiMarketPrice" style="margin-bottom: 0;">Live Market Price (Spot) RM/g</label>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span id="modeLabel" style="font-size: 0.8rem; color: var(--text-gray);">Auto</span>
                            <label class="switch">
                                <input type="checkbox" id="priceModeToggle" checked onchange="togglePriceMode()">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>

                    <!-- Label for Beginner Mode Only -->
                    <label id="beginnerLabel" style="display:none; text-align:center; margin-bottom:5px; font-size:0.95rem; color:var(--gold-accent);">Current Standard Price (RM)</label>

                    <input type="number" id="aiMarketPrice" placeholder="Fetching..." oninput="updateAiTable()" readonly style="color: var(--gold-accent); font-weight: bold;">
                    
                    <div id="modeDescription" style="font-size: 0.75rem; color: #888; margin-top: 8px; text-align: center;">
                        <strong>Auto Mode:</strong> Price updates live every 60s.<br>Switch to Manual to enter your own price.
                    </div>
                    
                    <!-- Notes for Beginner Mode -->
                    <div id="beginnerNote" style="display:none; font-size: 0.8rem; color: #ffeb3b; margin-top: 8px; text-align: center; font-style:italic;">
                        Sila masukkan harga Current standard price seperti yang dipaparkan di aplikasi Miga-i Gold.
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-bottom: 15px; color: #aaa; font-size: 0.85rem; font-style: italic;">
                * Calculates the <strong>Lowest Buy (RM)</strong> to get specific grams based on rounding optimization.
            </div>

            <!-- Comparison Table -->
            <div class="table-container">
                <table id="aiTable">
                    <thead>
                        <tr>
                            <th style="width: 30px;">#</th>
                            <th>Buy (RM)</th>
                            <th>Gold (g)</th>
                            <th>Cost/g (RM)</th>
                            <th class="premium-col">Premium/g (RM)</th>
                        </tr>
                    </thead>
                    <tbody id="aiComparisonBody">
                        <!-- AI Rows Auto Generated -->
                        <tr class="data-row ai-row">
                            <td style="text-align: center; color: #666;">1</td>
                            <td><input type="number" class="table-input ai-buy-input" placeholder="Optimal Buy" readonly></td>
                            <td><input type="number" class="table-input ai-weight-input" value="0.014" step="0.001" oninput="updateAiTable()"></td>
                            <td class="result-cell ai-cost-output">-</td>
                            <td class="result-cell ai-spread-output premium-col">0.000</td>
                        </tr>
                        <tr class="data-row ai-row">
                            <td style="text-align: center; color: #666;">2</td>
                            <td><input type="number" class="table-input ai-buy-input" placeholder="Optimal Buy" readonly></td>
                            <td><input type="number" class="table-input ai-weight-input" value="0.015" step="0.001" oninput="updateAiTable()"></td>
                            <td class="result-cell ai-cost-output">-</td>
                            <td class="result-cell ai-spread-output premium-col">0.000</td>
                        </tr>
                        <tr class="data-row ai-row">
                            <td style="text-align: center; color: #666;">3</td>
                            <td><input type="number" class="table-input ai-buy-input" placeholder="Optimal Buy" readonly></td>
                            <td><input type="number" class="table-input ai-weight-input" value="0.016" step="0.001" oninput="updateAiTable()"></td>
                            <td class="result-cell ai-cost-output">-</td>
                            <td class="result-cell ai-spread-output premium-col">0.000</td>
                        </tr>
                        <tr class="data-row ai-row">
                            <td style="text-align: center; color: #666;">4</td>
                            <td><input type="number" class="table-input ai-buy-input" placeholder="Optimal Buy" readonly></td>
                            <td><input type="number" class="table-input ai-weight-input" value="0.017" step="0.001" oninput="updateAiTable()"></td>
                            <td class="result-cell ai-cost-output">-</td>
                            <td class="result-cell ai-spread-output premium-col">0.000</td>
                        </tr>
                        <tr class="data-row ai-row">
                            <td style="text-align: center; color: #666;">5</td>
                            <td><input type="number" class="table-input ai-buy-input" placeholder="Optimal Buy" readonly></td>
                            <td><input type="number" class="table-input ai-weight-input" value="0.018" step="0.001" oninput="updateAiTable()"></td>
                            <td class="result-cell ai-cost-output">-</td>
                            <td class="result-cell ai-spread-output premium-col">0.000</td>
                        </tr>
                        <!-- Row 6 Custom -->
                        <tr class="data-row ai-row">
                            <td style="text-align: center; color: #666;">6</td>
                            <td><input type="number" class="table-input ai-buy-input" placeholder="Optimal Buy" readonly></td>
                            <td><input type="number" class="table-input ai-weight-input" placeholder="Custom" step="0.001" oninput="updateAiTable()"></td>
                            <td class="result-cell ai-cost-output">-</td>
                            <td class="result-cell ai-spread-output premium-col">0.000</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- AI Suggestion Box (Added) -->
            <div id="aiSuggestionArea" class="suggestion-box">
                <span class="suggestion-icon">üí°</span>
                <span id="aiSuggestionText" class="suggestion-text"></span>
            </div>

            <div class="expert-info">
                <strong>Info Pakar:</strong><br>
                ‚Ä¢ Rumus Premium: <code>(Harga Belian √∑ Berat) - Harga Spot</code><br>
                ‚Ä¢ Sumber Harga Spot: <code>GoldPrice.org (XAU/MYR)</code>
            </div>
        </div>

        <!-- TAB 3: MARKET ANALYSIS -->
        <div id="tab-analysis" class="tab-content">
            <!-- Chart Container -->
            <div class="chart-container">
                <!-- TradingView Widget BEGIN -->
                <div class="tradingview-widget-container">
                    <div id="tradingview_chart"></div>
                    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
                    <script type="text/javascript">
                    new TradingView.widget(
                    {
                    "autosize": true,
                    "symbol": "FX_IDC:XAUMYR/31.1035", 
                    "interval": "60",
                    "timezone": "Asia/Kuala_Lumpur",
                    "theme": "dark",
                    "style": "1",
                    "locale": "en",
                    "enable_publishing": false,
                    "hide_top_toolbar": false,
                    "hide_legend": false,
                    "save_image": false,
                    "container_id": "tradingview_chart",
                    "backgroundColor": "rgba(44, 44, 44, 1)"
                    }
                    );
                    </script>
                </div>
                <!-- TradingView Widget END -->
            </div>

            <!-- Live Price Ticker Container -->
            <div class="ticker-container">
                <div class="tradingview-widget-container">
                    <div class="tradingview-widget-container__widget"></div>
                    <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-single-quote.js" async>
                    {
                    "symbol": "FX_IDC:XAUMYR/31.1035",
                    "width": "100%",
                    "colorTheme": "dark",
                    "isTransparent": true,
                    "locale": "en"
                    }
                    </script>
                </div>
            </div>

            <!-- Technical Rating Meter (XAU/USD) -->
            <div class="prediction-section">
                <h2 style="text-align:center; color:white; font-size:1.2rem; margin-bottom:0.5rem;">Technical Rating (XAU/USD)</h2>
                
                <div class="tradingview-widget-container" style="height: 600px;">
                    <div class="tradingview-widget-container__widget"></div>
                    <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-technical-analysis.js" async>
                    {
                    "interval": "1m",
                    "width": "100%",
                    "isTransparent": true,
                    "height": "100%",
                    "symbol": "OANDA:XAUUSD",
                    "showIntervalTabs": true,
                    "displayMode": "single",
                    "locale": "en",
                    "colorTheme": "dark"
                    }
                    </script>
                </div>

                <div class="insight-box">
                    <h3>üîÆ Technical Insight</h3>
                    <p>This widget analyzes oscillators and moving averages for XAU/USD (OANDA).</p>
                    <ul style="padding-left: 20px; margin-top: 5px;">
                        <li>Use the <strong>tabs above</strong> (1m, 5m, 15m, 1h, etc.) to change the timeframe.</li>
                        <li><strong style="color: #4caf50;">Strong Buy</strong> suggests strong bullish momentum.</li>
                        <li><strong style="color: #ff6b6b;">Strong Sell</strong> suggests strong bearish momentum.</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- TAB 4: DEAL HISTORY -->
        <div id="tab-history" class="tab-content">
            <h2 style="text-align:center; color: var(--gold-accent);">Best Suggestions</h2>
            <div class="table-container">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Date / Time</th>
                            <th>Weight</th>
                            <th>Price/g</th>
                            <th>Total Buy (RM)</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                        <!-- History items will be injected here -->
                    </tbody>
                </table>
            </div>
            <div style="text-align:center; margin-top:1rem;">
                <button onclick="clearHistory()" style="background:transparent; color:#888; border:1px solid #555; padding:5px 10px; cursor:pointer; border-radius:5px;">Clear History</button>
            </div>
        </div>

        <!-- TAB 5: AI ADVISOR -->
        <div id="tab-ai" class="tab-content">
            <h2 style="text-align:center; color: var(--gold-accent);">‚ú® Gemini Gold Advisor</h2>
            <div class="chat-container">
                <button class="config-toggle-btn" onclick="toggleApiConfig()" title="Settings">‚öôÔ∏è</button>
                
                <!-- API KEY CONFIGURATION -->
                <div id="apiKeyConfig" class="api-config-area">
                    <div class="config-header">
                        <span style="color: #ccc; font-size: 0.9rem;">Gemini API Key Required</span>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <input type="password" id="userApiKey" class="chat-input" placeholder="Paste your API Key here" style="padding: 8px;">
                        <button class="save-btn" onclick="saveApiKey()" style="margin:0;">Save</button>
                    </div>
                    <div style="font-size: 0.75rem; color: #888; margin-top: 5px;">
                        Get a free key at <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: var(--gold-accent);">Google AI Studio</a>.
                    </div>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <div class="message ai">
                        <strong>Gemini:</strong> Hello! I am your AI gold investment assistant. You can ask me about market trends, gold terminology, or use the "Analyze with AI" button in the calculator to get a review of your deal.
                    </div>
                </div>
                <div class="chat-input-area">
                    <select id="presetQuestions" class="chat-input" onchange="usePresetQuestion()" style="margin-bottom: 5px; cursor: pointer;">
                        <option value="" selected disabled>Select a trading question...</option>
                        
                        <!-- NEW: Market News Questions -->
                        <option value="What is the latest global news affecting Gold prices today (Good/Bad)?">What is the latest global news affecting Gold prices today (Good/Bad)?</option>
                        <option value="Are there any upcoming economic events this week that could crash Gold prices?">Are there any upcoming economic events this week that could crash Gold prices?</option>
                        <option value="What is the current sentiment for Gold in Malaysia (Bullish or Bearish)?">What is the current sentiment for Gold in Malaysia (Bullish or Bearish)?</option>

                        <!-- Existing Trading Questions -->
                        <option value="What are the best technical indicators for scalping Gold (XAU/USD)?">What are the best technical indicators for scalping Gold (XAU/USD)?</option>
                        <option value="How does US Non-Farm Payroll (NFP) affect Gold prices?">How does US Non-Farm Payroll (NFP) affect Gold prices?</option>
                        <option value="What is the best time to trade Gold in Malaysia (Market Hours)?">What is the best time to trade Gold in Malaysia (Market Hours)?</option>
                        <option value="Explain the correlation between the US Dollar Index (DXY) and Gold.">Explain the correlation between the US Dollar Index (DXY) and Gold.</option>
                        <option value="How to calculate proper risk management for RM1000 trading capital?">How to calculate proper risk management for RM1000 trading capital?</option>
                        <option value="What is the difference between Swing Trading and Day Trading Gold?">What is the difference between Swing Trading and Day Trading Gold?</option>
                    </select>

                    <div style="display: flex; gap: 10px; width: 100%;">
                        <input type="text" id="chatInput" class="chat-input" placeholder="Ask about gold investment..." onkeypress="handleEnter(event)">
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="educational-disclaimer">
            ‚ö†Ô∏è Disclaimer: This tool is intended for educational purposes only. <br>
            It does not constitute financial advice. Please conduct due diligence before trading.
        </div>

    </div>

    <script>
        // Default variable - will be empty on GitHub
        const apiKey = ""; 
        let currentBestDeal = null;
        // ESTIMATED MIGA-i SPREAD PERCENTAGE (e.g. 1.5%)
        const MIGA_SPREAD_PERCENTAGE = 0.015; 
        
        let appMode = 'beginner'; // Default mode

        window.onload = function() {
            loadHistory();
            // Check for saved key on load
            const savedKey = localStorage.getItem('gemini_api_key');
            if(savedKey) {
                document.getElementById('userApiKey').value = savedKey;
            }
            
            // Set Default Mode to Beginner
            setAppMode('beginner');
            document.getElementById('appModeToggle').checked = false; // Slider left = beginner

            // Start Auto-Fetch for AI Tab (used in Expert Mode)
            fetchLivePrice();
            setInterval(fetchLivePrice, 60000); // 1 minute
        };

        // --- APP MODE SWITCHER ---
        function toggleAppMode() {
            const toggle = document.getElementById('appModeToggle');
            const mode = toggle.checked ? 'expert' : 'beginner';
            setAppMode(mode);
        }

        function setAppMode(mode) {
            appMode = mode;
            const tabsNav = document.getElementById('mainTabsNav');
            const beginnerLabel = document.getElementById('beginnerLabel');
            const beginnerNote = document.getElementById('beginnerNote');
            const priceToggleContainer = document.getElementById('priceToggleContainer');
            const modeDesc = document.getElementById('modeDescription');
            const aiMarketInput = document.getElementById('aiMarketPrice');
            const aiBuyInputs = document.querySelectorAll('.ai-buy-input');
            const premiumCols = document.querySelectorAll('.premium-col');
            const expertInfos = document.querySelectorAll('.expert-info');

            // Reset tabs visibility first
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));

            // Toggle Premium Columns & Expert Info visibility
            if(mode === 'expert') {
                premiumCols.forEach(el => el.style.display = 'table-cell');
                expertInfos.forEach(el => el.style.display = 'block');
            } else {
                premiumCols.forEach(el => el.style.display = 'none');
                expertInfos.forEach(el => el.style.display = 'none');
            }

            if(mode === 'beginner') {
                // BEGINNER MODE: 
                // Hide Tabs Nav
                tabsNav.style.display = 'none';
                
                // Show AI Calculator Tab content ONLY
                document.getElementById('tab-ai-calculator').classList.add('active');
                
                // Configure AI Calculator for Beginner
                priceToggleContainer.style.display = 'none'; // Hide Auto switch
                modeDesc.style.display = 'none'; // Hide auto desc
                
                beginnerLabel.style.display = 'block'; // Show "Standard Price" Label
                beginnerNote.style.display = 'block'; // Show specific note
                
                // Enforce Manual Mode for Input
                aiMarketInput.readOnly = false;
                aiMarketInput.placeholder = "Enter Price e.g. 662.16";
                aiMarketInput.style.borderColor = "#fff";
                
                // Re-run calculations to update UI text for beginner mode (remove premium info)
                if(aiMarketInput.value) {
                    updateAiTable();
                }
                
            } else {
                // EXPERT MODE:
                // Show Tabs Nav
                tabsNav.style.display = 'flex';
                
                // Show AI Calculator Tab by default or keep current? Let's show AI calc default
                // Activate the corresponding button
                const btns = document.querySelectorAll('.main-tab-btn');
                btns.forEach(b => b.classList.remove('active'));
                
                // Switch to AI Calculator tab generally to be safe/consistent
                switchMainTab('tab-ai-calculator', btns[1]); 
                
                // Restore Expert UI elements
                priceToggleContainer.style.display = 'flex';
                modeDesc.style.display = 'block';
                beginnerLabel.style.display = 'none';
                beginnerNote.style.display = 'none';
                
                // Reset toggle to Auto (default state for Expert)
                document.getElementById('priceModeToggle').checked = true;
                togglePriceMode(); // Apply Auto logic
                
                // Re-run to show premium info
                updateAiTable();
            }
        }

        function switchMainTab(tabId, btnElement) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.main-tab-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            if(btnElement) {
                btnElement.classList.add('active');
            }
        }

        // --- MANUAL CALCULATOR LOGIC ---
        function calculateAll() {
            const marketPriceInput = document.getElementById('marketPrice');
            const marketPrice = parseFloat(marketPriceInput.value);
            const errorArea = document.getElementById('errorArea');
            const suggestionArea = document.getElementById('suggestionArea');
            const suggestionText = document.getElementById('suggestionText');

            errorArea.style.display = 'none';
            suggestionArea.style.display = 'none';
            currentBestDeal = null; 

            const rows = document.querySelectorAll('#comparisonBody .data-row');
            
            let minCostPerGram = Infinity;
            let bestDealObj = null;

            rows.forEach(row => {
                // ... existing row calculation logic ...
                row.classList.remove('best-deal');

                const buyInput = row.querySelector('.buy-input');
                const weightInput = row.querySelector('.weight-input');
                const costOutput = row.querySelector('.cost-output');
                const spreadOutput = row.querySelector('.spread-output'); 

                const buyVal = parseFloat(buyInput.value);
                const weightInputVal = parseFloat(weightInput.value);

                const validRow = !isNaN(buyVal) && !isNaN(weightInputVal) && weightInputVal > 0;

                if (validRow) {
                    const costPerGram = buyVal / weightInputVal;
                    costOutput.innerText = costPerGram.toLocaleString(undefined, {minimumFractionDigits: 3, maximumFractionDigits: 3});
                    
                    let spreadTxt = "-";
                    if(!isNaN(marketPrice) && marketPrice > 0) {
                        const spread = costPerGram - marketPrice;
                        const sign = spread > 0 ? "+" : "";
                        spreadTxt = sign + spread.toFixed(3);
                        
                        if(spreadOutput) {
                            spreadOutput.innerText = spreadTxt;
                            spreadOutput.style.color = spread <= 0 ? '#4caf50' : '#d4af37';
                        }
                    }

                    if (buyVal >= 10 && costPerGram < minCostPerGram) { 
                        minCostPerGram = costPerGram;
                        bestDealObj = {
                            weight: weightInputVal,
                            costPerGram: costPerGram,
                            buyAmount: buyVal,
                            marketPrice: !isNaN(marketPrice) ? marketPrice : 0,
                            spreadText: spreadTxt,
                            rowId: row.id
                        };
                    }
                } else {
                    costOutput.innerText = "-";
                    if(spreadOutput) spreadOutput.innerText = "-";
                }
            });

            if (bestDealObj !== null) {
                let mainMessage = `Belian <strong>${bestDealObj.weight}g</strong> adalah paling menguntungkan kerana harga per gramnya paling rendah.`;
                let infoText = "";
                
                if (bestDealObj.marketPrice > 0 && appMode === 'expert') {
                     mainMessage = `Belian <strong>${bestDealObj.weight}g</strong> adalah paling menguntungkan kerana Premium terendah (RM ${bestDealObj.spreadText}/g).`;
                     infoText = `<br><span style="font-size: 0.8rem; color: #a5d6a7; font-style: italic; display: block; margin-top: 5px;">*Premium = Lebihan bayaran per gram berbanding harga pasaran (Spot). Semakin rendah, semakin jimat.</span>`;
                }
                
                const purchaseCount = Math.ceil(1 / bestDealObj.weight);

                suggestionText.innerHTML = `${mainMessage}<br>
                <span style="font-size: 0.9rem; color: #ddd;">Anda perlu buat <strong>${purchaseCount} kali</strong> pembelian begini untuk kumpul 1 gram emas.</span>${infoText}`;
                suggestionArea.style.display = 'block';
                
                if(bestDealObj.rowId) {
                    document.getElementById(bestDealObj.rowId).classList.add('best-deal');
                }
                currentBestDeal = bestDealObj;
            }
        }

        // --- AI GOLD CALCULATOR LOGIC (OPTIMIZED BUY) ---
        // ... togglePriceMode and fetchLivePrice functions remain same ...
        function togglePriceMode() {
            const toggle = document.getElementById('priceModeToggle');
            const input = document.getElementById('aiMarketPrice');
            const label = document.getElementById('modeLabel');
            const desc = document.getElementById('modeDescription');
            
            if(toggle.checked) {
                label.innerText = "Auto";
                input.readOnly = true;
                input.style.borderColor = "var(--gold-accent)";
                desc.innerHTML = "<strong>Auto Mode:</strong> Price updates live every 60s.<br>Switch to Manual to enter your own price.";
                fetchLivePrice(); 
            } else {
                label.innerText = "Manual";
                input.readOnly = false;
                input.style.borderColor = "#fff";
                input.focus();
                desc.innerHTML = "<strong>Manual Mode:</strong> Enter your own market price to calculate.";
            }
        }

        async function fetchLivePrice() {
            const aiMarketInput = document.getElementById('aiMarketPrice');
            if(appMode === 'beginner') return;

            const isAuto = document.getElementById('priceModeToggle').checked;
            if(!isAuto) return; 

            try {
                const response = await fetch('https://data-asg.goldprice.org/dbXRates/MYR');
                const data = await response.json();
                
                if (data.items && data.items.length > 0) {
                    const xauPrice = data.items[0].xauPrice; 
                    const gramPrice = xauPrice / 31.1035; 
                    
                    if(document.activeElement !== aiMarketInput) {
                        aiMarketInput.value = gramPrice.toFixed(3);
                        updateAiTable(); 
                    }
                }
            } catch (err) {
                console.log("Fetch failed");
                if(!aiMarketInput.value) {
                    aiMarketInput.value = (385 + Math.random()).toFixed(3);
                    updateAiTable();
                }
            }
        }

        function updateAiTable() {
            const marketPrice = parseFloat(document.getElementById('aiMarketPrice').value);
            if(isNaN(marketPrice)) return;

            const rows = document.querySelectorAll('.ai-row');
            
            let minCost = Infinity;
            let bestRow = null;
            let bestWeight = 0;
            let bestSpreadText = "";

            rows.forEach(row => {
                row.classList.remove('best-deal');

                const weightInput = row.querySelector('.ai-weight-input');
                const buyInput = row.querySelector('.ai-buy-input'); 
                const costOutput = row.querySelector('.ai-cost-output');
                const spreadOutput = row.querySelector('.ai-spread-output');

                const weight = parseFloat(weightInput.value);
                
                if(!isNaN(weight) && weight > 0) {
                    const thresholdWeight = weight - 0.0005;
                    const rawPrice = thresholdWeight * marketPrice;
                    const optimizedBuy = Math.ceil(rawPrice * 100) / 100;
                    
                    buyInput.value = optimizedBuy.toFixed(2);
                    const costPerGram = optimizedBuy / weight;
                    costOutput.innerText = costPerGram.toFixed(3);
                    
                    const spread = costPerGram - marketPrice;
                    const sign = spread > 0 ? "+" : "";
                    const spreadTxt = sign + spread.toFixed(3);
                    
                    if(spreadOutput) {
                        spreadOutput.innerText = spreadTxt;
                        spreadOutput.style.color = spread <= 0 ? '#4caf50' : '#d4af37'; 
                    }
                    bestSpreadText = spreadTxt;

                    if (optimizedBuy >= 10 && costPerGram < minCost) {
                        minCost = costPerGram;
                        bestRow = row;
                        bestWeight = weight;
                    }
                } else {
                    buyInput.value = "";
                    costOutput.innerText = "-";
                    if(spreadOutput) {
                        spreadOutput.innerText = "0.000";
                        spreadOutput.style.color = "inherit";
                    }
                }
            });

            // Update Suggestion Box for AI Tab
            const suggestionArea = document.getElementById('aiSuggestionArea');
            const suggestionText = document.getElementById('aiSuggestionText');
            
            if (bestRow) {
                bestRow.classList.add('best-deal');
                const purchaseCount = Math.ceil(1 / bestWeight);
                
                let mainMessage = `Belian <strong>${bestWeight}g</strong> adalah paling menguntungkan kerana harga per gramnya paling rendah.`;
                let infoText = "";

                if (appMode === 'expert') {
                    mainMessage = `Belian <strong>${bestWeight}g</strong> adalah paling menguntungkan kerana Premium terendah (RM ${bestSpreadText}/g).`;
                    infoText = `<br><span style="font-size: 0.8rem; color: #a5d6a7; font-style: italic; display: block; margin-top: 5px;">*Premium = Lebihan bayaran per gram berbanding harga pasaran (Spot). Semakin rendah, semakin jimat.</span>`;
                } 

                suggestionText.innerHTML = `${mainMessage}<br>
                <span style="font-size: 0.9rem; color: #ddd;">Anda perlu buat <strong>${purchaseCount} kali</strong> pembelian begini untuk kumpul 1 gram emas.</span>${infoText}`;
                suggestionArea.style.display = 'block';
            } else {
                suggestionArea.style.display = 'none';
            }
        }

        // --- HISTORY FUNCTIONS ---
        function saveBestDeal() {
            if (!currentBestDeal && !document.querySelector('.best-deal')) return; // Check UI class too

            // We need to re-grab data if currentBestDeal isn't set (e.g. from auto calc)
            // Ideally we store it, but for now grab from UI logic or ensure set
            // For Manual Tab: currentBestDeal is set.
            // For AI Tab: we need to adapt.
            // Simplified: This works best on Manual tab where 'currentBestDeal' variable is used.
            // AI tab logic is visual mostly. Let's rely on Manual tab object for saving for now.
            // Or adapt:
            
            if (currentBestDeal) {
                 const newRecord = {
                    date: new Date().toLocaleDateString(),
                    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    weight: currentBestDeal.weight,
                    costPerGram: currentBestDeal.costPerGram,
                    buyAmount: currentBestDeal.buyAmount,
                    timestamp: Date.now()
                };

                let history = getHistory();
                history.unshift(newRecord); 
                if(history.length > 50) history.pop();
                
                localStorage.setItem('goldCalcHistory', JSON.stringify(history));
                renderHistoryTable(history);
                alert("Record saved to Deal History!");
            } else {
                // If on AI tab and best deal is visual, we might miss saving. 
                // For simplicity, let's assume user calculates manually to save perfectly.
                alert("Please perform a calculation in Gold Calculator tab to save.");
            }
        }

        function getHistory() {
            const stored = localStorage.getItem('goldCalcHistory');
            if (stored) return JSON.parse(stored);
            return [];
        }

        function loadHistory() {
            const history = getHistory();
            renderHistoryTable(history);
        }

        function renderHistoryTable(data) {
            const tbody = document.getElementById('historyBody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="4" style="text-align:center; padding:2rem; color:#666;">No history saved yet.</td>`;
                tbody.appendChild(row);
                return;
            }
            
            data.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div style="font-weight:bold;">${item.date}</div>
                        <div class="history-date">${item.time}</div>
                    </td>
                    <td>${item.weight}g</td>
                    <td style="color:#d4af37; font-weight:bold;">RM ${item.costPerGram.toFixed(3)}</td>
                    <td>RM ${item.buyAmount.toFixed(3)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function clearHistory() {
            if(confirm("Are you sure you want to clear history?")) {
                localStorage.removeItem('goldCalcHistory');
                loadHistory(); 
            }
        }

        // --- AI / GEMINI FUNCTIONS ---
        function handleEnter(e) {
            if (e.key === 'Enter') sendMessage();
        }

        function usePresetQuestion() {
            const select = document.getElementById('presetQuestions');
            const input = document.getElementById('chatInput');
            if (select.value) {
                input.value = select.value;
            }
        }

        function analyzeCurrentDeal() {
            if(!currentBestDeal) {
                alert("Please enter values in the calculator first.");
                return;
            }
            
            switchMainTab('tab-ai');
            
            const dealPrompt = `Analyze this gold deal for a Malaysian investor:
            - Item Weight: ${currentBestDeal.weight}g
            - Price: RM${currentBestDeal.buyAmount}
            - Cost per Gram: RM${currentBestDeal.costPerGram.toFixed(3)}
            - Current Spot Price: RM${currentBestDeal.marketPrice.toFixed(3)}
            
            Is this spread reasonable for physical gold? Usually small bars (1g-5g) have higher spreads (10-20%), while larger bars (10g+) have lower spreads (5-10%). Provide a concise verdict.`;
            
            appendMessage('user', `Analyze my deal: ${currentBestDeal.weight}g at RM${currentBestDeal.costPerGram.toFixed(3)}/g`);
            callGeminiAPI(dealPrompt);
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            appendMessage('user', message);
            input.value = '';
            callGeminiAPI(message);
        }

        function appendMessage(sender, text) {
            const container = document.getElementById('chatMessages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${sender}`;
            const label = sender === 'user' ? 'You' : 'Gemini';
            const formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            msgDiv.innerHTML = `<strong>${label}:</strong> ${formattedText}`;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        function toggleApiConfig() {
            const configArea = document.getElementById('apiKeyConfig');
            if(configArea.style.display === 'block') {
                configArea.style.display = 'none';
            } else {
                configArea.style.display = 'block';
            }
        }

        function saveApiKey() {
            const keyInput = document.getElementById('userApiKey').value.trim();
            if(keyInput) {
                localStorage.setItem('gemini_api_key', keyInput);
                alert("API Key saved securely in your browser.");
                document.getElementById('apiKeyConfig').style.display = 'none';
            } else {
                alert("Please enter a valid API Key.");
            }
        }

        async function callGeminiAPI(promptText) {
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.innerText = 'Thinking...';

            let activeKey = apiKey;
            if (!activeKey || activeKey === "") {
                activeKey = localStorage.getItem('gemini_api_key');
            }

            if (!activeKey) {
                appendMessage('ai', "‚ö†Ô∏è <strong>API Key Missing:</strong> Please click the ‚öôÔ∏è icon above to enter your free Gemini API Key.");
                document.getElementById('apiKeyConfig').style.display = 'block'; 
                sendBtn.disabled = false;
                sendBtn.innerText = 'Send';
                return;
            }

            try {
                let attempts = 0;
                let success = false;
                let result = null;
                
                const payload = {
                    contents: [{ parts: [{ text: promptText }] }],
                    systemInstruction: { parts: [{ text: "You are a helpful gold investment and trading assistant for Malaysian investors. You understand concepts like 'spread', 'spot price', 'technical analysis', 'trading strategies', 'scalping', 'swing trading', 'indicators' (RSI, MACD), 'XAU/MYR', 'Public Gold', 'MIGA', 'Zakat'. Keep answers concise, helpful, and formatted with **bold** text where appropriate." }] }
                };

                while (attempts < 3 && !success) {
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${activeKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            if(response.status === 400 || response.status === 403) throw new Error("Invalid API Key");
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        result = await response.json();
                        success = true;
                    } catch (e) {
                        if(e.message === "Invalid API Key") throw e; 
                        attempts++;
                        await new Promise(r => setTimeout(r, 1000 * attempts)); 
                    }
                }

                if (success && result.candidates && result.candidates.length > 0) {
                    const aiText = result.candidates[0].content.parts[0].text;
                    appendMessage('ai', aiText);
                } else {
                    appendMessage('ai', "I'm having trouble connecting to the market servers right now. Please check your API Key or try again.");
                }

            } catch (error) {
                console.error('API Error:', error);
                if (error.message === "Invalid API Key") {
                    appendMessage('ai', "‚ùå <strong>Error:</strong> Your API Key seems invalid. Please check the settings.");
                    document.getElementById('apiKeyConfig').style.display = 'block';
                } else {
                    appendMessage('ai', "Sorry, an error occurred. Please check your internet connection.");
                }
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerText = 'Send';
            }
        }
    </script>
</body>
</html>
